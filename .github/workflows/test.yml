name: ANTsTorch Unit Tests

on:
  pull_request:
    types: [opened, synchronize]
    branches: [master]
  workflow_call:
  workflow_dispatch:

env:
  USE_ANTSPY_SOURCE_BUILD: false

jobs:

  #################################################
  # Job 1 ‚Äî Prepare ANTsTorch data and models cache
  #################################################
  prepare-data:
    name: Prepare ANTsTorch data and models cache
    runs-on: ubuntu-22.04

    outputs:
      cache-key: ${{ steps.compute-key.outputs.cache-key }}
      # cache-hit is set by actions/cache
      cache-hit: ${{ steps.restore-cache.outputs.cache-hit }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set cache location and compute key
        id: compute-key
        run: |
          echo "ANTSTORCH_CACHE_DIR=${{ runner.temp }}/.antstorch" >> "$GITHUB_ENV"
          KEY="antstorch-${{ hashFiles(
            'antstorch/utilities/get_antstorch_data.py',
            'antstorch/utilities/get_pretrained_network.py'
          ) }}"
          echo "cache-key=$KEY" >> "$GITHUB_OUTPUT"

      - name: Try restoring ANTsTorch data cache
        id: restore-cache
        uses: actions/cache/restore@v5
        with:
          key: ${{ steps.compute-key.outputs.cache-key }}
          path: ${{ env.ANTSTORCH_CACHE_DIR }}

      - name: Cache hit ‚Äî skip download
        if: steps.restore-cache.outputs.cache-hit == 'true'
        run: |
          echo "Cache HIT ‚Äî will use cached ANTsTorch data."
          rm -rf ${{ env.ANTSTORCH_CACHE_DIR }}

      - name: Set up Python 3.11
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install ANTsPy
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: |
          if [ "$USE_ANTSPY_SOURCE_BUILD" = "true" ]; then
            echo "Installing ANTsPy from source..."
            git clone https://github.com/ANTsX/ANTsPy.git
            pip install scikit-build-core pybind11 nanobind
            pip install ./ANTsPy --no-build-isolation --no-deps
          else
            echo "Installing ANTsPy from PyPI..."
            pip install antspyx
          fi

      - name: Download ANTsTorch models (cache miss)
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: |
          pip install -e .
          python tools/download_antstorch_data.py --strict --cache-dir ${{ env.ANTSTORCH_CACHE_DIR }}

      - name: Save newly downloaded ANTsTorch data to cache
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          key: ${{ steps.compute-key.outputs.cache-key }}
          path: ${{ env.ANTSTORCH_CACHE_DIR }}


  #################################################
  # Job 2 ‚Äî run tests
  #################################################
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-22.04
    needs: prepare-data

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.13"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download ANTsTorch data and models artifact
        uses: actions/download-artifact@v7
        with:
         name: ANTsTorch-data-${{ needs.prepare-data.outputs.cache-key }}
         path: ~/.antstorch

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential git

      - name: Install ANTsPy
        run: |
          if [ "$USE_ANTSPY_SOURCE_BUILD" = "true" ]; then
            echo "Installing ANTsPy from source..."
            git clone https://github.com/ANTsX/ANTsPy.git
            pip install scikit-build-core pybind11 nanobind
            pip install ./ANTsPy --no-build-isolation --no-deps
          else
            echo "Installing ANTsPy from PyPI..."
            pip install antspyx
          fi

      - name: Install ANTsTorch and dependencies
        run: |
          pip install -e .

      - name: Run tests (individually via pytest)
        run: |
          pip install pytest pytest-xdist pytest-forked psutil
          for f in tests/test_*.py; do
            echo "üîç Running $f"
            python -c "import psutil; print('Memory before:', psutil.virtual_memory().used // (1024*1024), 'MB')"
            pytest -v -s --forked "$f" || exit 1
            python -c "import psutil; print('Memory after :', psutil.virtual_memory().used // (1024*1024), 'MB')"
          done
